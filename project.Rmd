---
title: "Project"
author: "Manuel Alejandro"
date: "5/14/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


```



## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


```{r}
library(readr)
library(lubridate)
library(ggplot2)
library(dplyr)
library(zoo)
```


```{r}
umsatzdaten <- read_csv("umsatzdaten_gekuerzt.csv")
```
Erstellung der Variable mit Wochentag
```{r}
# Berechnung der Wochentage
umsatzdaten$wochentag <- weekdays(umsatzdaten$Datum)

# Umwandlung von 'wochentag" in eine Faktor-Variable mit einer vorgegeben Sortierung der Level (Kategorien)
umsatzdaten$wochentag <- factor(umsatzdaten$wochentag, levels=c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

```

Alle Warengruppen eines Tages zusammen fügen
```{r}

```

Erstellung der Variable mit Jahreszeit
```{r}
# Berechnung der Jahresqrt
yq <- as.yearqtr(as.yearmon(umsatzdaten$Datum, "%m/%d/%Y") + 1/12)
# Berechnung der Jahreszeit
umsatzdaten$jahreszeit <- factor(format(yq, "%q"), levels = 1:4, 
      labels = c("Winter", "Frueling", "Sommer", "Herbst"))


```

Erstellung der Variable mit Feiertage 
```{r}
#Einbinden der Bibliothek mit dr Funktion isHoliday:
detach("package:timeDate", unload = TRUE)
library(RQuantLib)

#Zeige deutsche Feiertage an:
getHolidayList("Germany", as.Date("2013-01-01"), as.Date("2020-01-01"))

#Füge die Feiertage "Himmelfahrt", "Pfingsten", "Tag deutscher Einheit" und "Reformationstag" zwischen 2013 und 2022 hinzu:
further_holidays <- (as.Date(c("2013-10-03", "2014-10-03", "2015-10-03", "2016-10-03", "2017-10-03", "2018-10-03", "2019-10-03", "2020-10-03", "2021-10-03", "2017-10-31", "2018-10-31", "2019-10-31", "2020-10-31", "2021-10-31", "2022-10-31", "2013-05-09", "2014-05-29", "2015-05-14", "2016-05-05", "2017-05-25", "2018-05-10", "2019-05-30", "2020-05-21", "2021-05-13", "2022-05-26", "2013-05-20", "2014-06-09", "2015-05-25", "2016-05-16", "2017-06-05", "2018-05-21", "2019-06-10", "2020-06-01", "2021-05-24", "2022-06-06", "2013-12-26", "2014-12-26", "2015-12-26", "2016-12-26", "2017-12-26", "2018-12-26", "2019-12-26", "2020-12-26", "2021-12-26", "2022-12-26")))
addHolidays("Germany", further_holidays)

#Erstelle neue Spalte mit dem Wert für Feiertag (Wochenenden ausgenommen):
umsatzdaten$holiday <- isHoliday("Germany", umsatzdaten$Datum) & !isWeekend("Germany", umsatzdaten$Datum)

View(umsatzdaten)
```

Langes Wochendende Vorher und nachher
Feiertag am Wochenende
```{r}

```

hat der Bäcker an manchen Tagen geschlossen = kein Umsatz
Vorher/nachher mehr umsatz 
```{r}
detach("package:RQuantLib", unload = TRUE)
library(timeDate)
all_dates <- tibble(Datum = as.Date(timeSequence(as.Date("2013-07-01"),as.Date("2019-06-03"))))

missing_dates <- anti_join(all_dates, umsatzdaten)


detach("package:timeDate", unload = TRUE)
library(RQuantLib)
missing_dates$holiday <- isHoliday("Germany", missing_dates$Datum)
missing_dates$WochentagMoFr <- !isWeekend("Germany", missing_dates$Datum)

```

Schulferien
```{r}
AshWednesday() #Funktion für Ferien in Deutschland
#Ferien
```


Kieler Woche:
1. Einbinden benötigter Bibliotheken
2. Einlesen der Daten
3. Zusammenführen der Daten
```{r}
library(readr)
library(dplyr)

#umsatzdaten <- read_csv("umsatzdaten_gekuerzt.csv")
kiwo <- read_csv("kiwo.csv")


umsatzdaten <- left_join(umsatzdaten, kiwo)
View(umsatzdaten)
```


Einbindung Wetterdaten
```{r}
library(readr)
library(dplyr)

wetter <- read_csv("wetter.csv")
View(wetter)

umsatzdaten<- left_join(umsatzdaten, wetter)
View(umsatzdaten)



```



Overfitting with linear regression
ToDo: Noch updaten!!
Importing Function Packages
```
```{r}
library(dplyr)
library(readr)
library(lubridate)
library(broom)
library(Metrics)
```

Datensatz in Training und Test Data teilen
https://duttashi.github.io/blog/splitting-a-data-frame-into-training-and-testing-sets-in-r/
```{r}
# To set a seed use the function set.seed()
set.seed(123)
library(caTools)
#70% training and 30% testing data
# umsatzdaten$spl will create a new column in the umsatzdaten dataset.</code>
umsatzdaten$spl=sample.split(umsatzdaten,SplitRatio=0.7)

View(umsatzdaten)
#Training data set
train=subset(umsatzdaten, umsatzdaten$spl==TRUE)
# where <i>spl== TRUE</i> means to add only those rows that have value true for spl in the training dataframe

# you will see that this dataframe has all values where umsatzdaten$spl==TRUE
View(train)

#Similarly, to create the testing dataset,
test=subset(umsatzdaten, umsatzdaten$spl==FALSE) 
View(test)
#where <i>spl== FALSE </i> means to add only those rows that have value true for spl in the training dataframe

> View(test)  you will see that this dataframe has all values where iris$spl==FALSE
```

Importing Training and Test Data
ToDo: Links noch updaten!!
```{r}
baecker_umsatzdaten_train <- read_csv("https://raw.githubusercontent.com/opencampus-sh/sose20-datascience/master/house_pricing_train.csv")
baecker_umsatzdaten_test <- read_csv("https://raw.githubusercontent.com/opencampus-sh/sose20-datascience/master/house_pricing_test.csv")
```

Estimating (Training) Models

(Alle Warengruppen getrennt anschauen)
```{r}
mod1 <- lm(Umsatz ~ wochentag, umsatzdaten)
mod2 <- lm(Umsatz ~ as.factor(Warengruppe), umsatzdaten)
mod3 <- lm(Umsatz ~ as.factor(Warengruppe)+ as.factor(wochentag), umsatzdaten)
mod4 <- lm(Umsatz ~ as.factor(Warengruppe)+ as.factor(wochentag)+ KielerWoche, umsatzdaten)

mod5 <- lm(Umsatz ~ as.factor(Warengruppe)+ as.factor(wochentag)+ KielerWoche+ Temperatur, umsatzdaten)
mod6 <- lm(Umsatz ~ as.factor(Warengruppe)+ as.factor(wochentag)+ KielerWoche+ Temperatur+holiday, umsatzdaten) 
mod7 <- lm(Umsatz ~ as.factor(Warengruppe)+ as.factor(wochentag)+ KielerWoche+ Temperatur+holiday+as.factor(jahreszeit), umsatzdaten) #Fehler

mod8 <- lm(Umsatz ~ as.factor(Warengruppe)+ as.factor(wochentag)+ KielerWoche+ Temperatur+holiday+Bewoelkung, umsatzdaten) 

mod4 <- lm(Umsatz ~ as.factor(bathrooms) + as.factor(zipcode) + condition, umsatzdaten)
mod5 <- lm(Umsatz ~ as.factor(bathrooms) + as.factor(zipcode) + as.factor(condition), umsatzdaten)
mod6 <- lm(Umsatz ~ as.factor(bathrooms) + as.factor(zipcode) + as.factor(condition) + sqft_living15, house_pricing_train)
mod7 <- lm(Umsatz ~ as.factor(bathrooms) + as.factor(zipcode) + as.factor(condition) + sqft_living15 + floors + view + grade + as.factor(zipcode)*as.factor(bathrooms), house_pricing_train)
```


```{r}
summary(mod1)
summary(mod2)
summary(mod3)
summary(mod4)
summary(mod5)
summary(mod6)
summary(mod7)
summary(mod8)
```

```{r}

glance(mod1)
glance(mod2)
```

Preparation of Model Results
```{r}
rbind(glance(mod1), glance(mod2), glance(mod3), glance(mod4), glance(mod5), glance(mod6), glance(mod7))
```

Model Prediction Quality for the Training Data Using the Mean Absolute Error
```{r}
rbind(mae(house_pricing_train$price, predict(mod1)),
      mae(house_pricing_train$price, predict(mod2)),
      mae(house_pricing_train$price, predict(mod3)),
      mae(house_pricing_train$price, predict(mod4)),
      mae(house_pricing_train$price, predict(mod5)),
      mae(house_pricing_train$price, predict(mod6)),
      mae(house_pricing_train$price, predict(mod7)))
```


Model Prediction Quality for the Training Data Using the Mean Absolute Percentage Error
```{r}
rbind(mape(house_pricing_train$price, predict(mod1)),
      mape(house_pricing_train$price, predict(mod2)),
      mape(house_pricing_train$price, predict(mod3)),
      mape(house_pricing_train$price, predict(mod4)),
      mape(house_pricing_train$price, predict(mod5)),
      mape(house_pricing_train$price, predict(mod6)),
      mape(house_pricing_train$price, predict(mod7)))
```

Model Prediction Quality for the (Unknown) Test Data Using the Mean Absolute Percentage Error
```{r}
rbind(mape(house_pricing_test$price, predict(mod1, newdata=house_pricing_test)),
      mape(house_pricing_test$price, predict(mod2, newdata=house_pricing_test)),
      mape(house_pricing_test$price, predict(mod3, newdata=house_pricing_test)),
      mape(house_pricing_test$price, predict(mod4, newdata=house_pricing_test)),
      mape(house_pricing_test$price, predict(mod5, newdata=house_pricing_test)),
      mape(house_pricing_test$price, predict(mod6, newdata=house_pricing_test)),
      mape(house_pricing_test$price, predict(mod7, newdata=house_pricing_test)))


```





